<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Deneme - Purchasing</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: #2196F3; color: white; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0 0 10px 0; font-size: 2.2em; }
        .header .date { font-size: 1.1em; opacity: 0.9; font-weight: normal; }
        .info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; }
        .controls { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-box input { width: 350px; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .refresh-btn { background: #4CAF50; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 15px; font-size: 14px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .stat { background: white; padding: 15px 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 120px; }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #2196F3; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        .table-container { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { background: #2196F3; color: white; padding: 12px 8px; text-align: left; cursor: pointer; position: relative; min-width: 120px; font-size: 13px; font-weight: 600; }
        th input { width: 95%; padding: 4px; margin-top: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; }
        td { padding: 10px 8px; border-bottom: 1px solid #eee; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        tr:hover { background: #f8f9fa; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:nth-child(even):hover { background: #f0f0f0; }
        .status-hazir { background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-normal { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .status-pending { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .date-cell { font-weight: 500; color: #1976d2; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .filtered-info { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 14px; }
        .column-count { color: #666; font-size: 12px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Pipeline Deneme - Purchasing</h1>
        <div class="date">22 Eyl√ºl 2025 - Pazartesi</div>
    </div>
    
    <div class="info">
        <strong>üìã Bilgi:</strong> "DURUMU" kolonunda "HAZIR" olan sipari≈üler g√∂sterilmemektedir.
    </div>
    
    <div class="controls">
        <div class="column-count">
            G√∂sterilen s√ºtunlar: Sƒ∞PARƒ∞≈û NUMARASI, TEDARƒ∞K√áƒ∞, TEDARƒ∞K√áƒ∞ KODU, A√áIKLAMA, Mƒ∞KTAR, RENK, Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞, TESLƒ∞M ALMA TARƒ∞Hƒ∞, DURUMU, Montaj Plan, Tamamlayƒ±cƒ± Plan
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <input type="text" id="searchInput" placeholder="üîç T√ºm tabloda ara...">
            <button class="refresh-btn" onclick="loadData()">üîÑ Verileri Yenile</button>
        </div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalRows">0</div>
                <div class="stat-label">Toplam Kayƒ±t</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="filteredRows">0</div>
                <div class="stat-label">G√∂sterilen</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="hiddenRows">0</div>
                <div class="stat-label">Gizlenen (HAZIR)</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="columnCount">11</div>
                <div class="stat-label">G√∂r√ºnen S√ºtun</div>
            </div>
        </div>
        
        <div id="filterInfo" class="filtered-info" style="display:none;"></div>
    </div>
    
    <div class="table-container">
        <div class="loading" id="loading">Python script'den pipeline verileri y√ºkleniyor...</div>
        <table id="dataTable" style="display:none;">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let columnFilters = {};
        const dateColumns = ['Sƒ∞PARƒ∞≈û TARƒ∞Hƒ∞', 'TESLƒ∞M ALMA TARƒ∞Hƒ∞'];
        let hiddenRowsCount = 0;
        
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dataTable').style.display = 'none';
                
                const response = await fetch('pipeline_data.json?' + Date.now());
                const data = await response.json();
                
                allData = data.data;
                hiddenRowsCount = data.filtered_rows || 0;
                
                // Filtreleme bilgisini g√∂ster
                if (hiddenRowsCount > 0) {
                    document.getElementById('filterInfo').style.display = 'block';
                    document.getElementById('filterInfo').innerHTML = 
                        `üìä Toplam ${data.original_rows} sipari≈üten ${hiddenRowsCount} tanesi 'DURUMU = HAZIR' olduƒüu i√ßin gizlendi.`;
                }
                
                resetFilters();
                createTable();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dataTable').style.display = 'table';
                
            } catch (error) {
                document.getElementById('loading').innerHTML = '‚ùå Pipeline verileri y√ºklenemedi: ' + error.message + '<br><small>pipeline_data.json dosyasƒ±nƒ±n olu≈üturulduƒüundan emin olun.</small>';
            }
        }
        
        function resetFilters() {
            columnFilters = {};
            filteredData = [...allData];
        }
        
        function createTable() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            if (allData.length === 0) return;
            
            // Header - sadece mevcut kolonlarƒ± g√∂ster
            const columns = Object.keys(allData[0]);
            thead.innerHTML = '<tr>' + columns.map(col => `
                <th onclick="sortTable('${col}')">
                    ${col}
                    <br>
                    <input type="text" placeholder="${col} filtrele..." 
                           onkeyup="filterByColumn('${col}', this.value)" 
                           onclick="event.stopPropagation()">
                </th>
            `).join('') + '</tr>';
            
            renderTableBody(columns);
        }
        
        function renderTableBody(columns) {
            const tbody = document.getElementById('tableBody');
            
            tbody.innerHTML = filteredData.map(row => 
                '<tr>' + columns.map(col => {
                    let value = row[col] || '';
                    let cellClass = '';
                    
                    // Tarih formatƒ± kontrol√º
                    if (dateColumns.includes(col) && value && value !== '' && value !== 'NaT' && value !== 'nan') {
                        // Eƒüer tarih formatƒ±nda ise (dd.mm.yyyy)
                        if (/^\d{2}\.\d{2}\.\d{4}$/.test(value)) {
                            cellClass = 'date-cell';
                        }
                    }
                    
                    // DURUMU kolonun √∂zel durumlarƒ±
                    if (col === 'DURUMU' && value && value !== '') {
                        const upperValue = value.toUpperCase();
                        if (upperValue === 'HAZIR') {
                            value = `<span class="status-hazir">${value}</span>`;
                        } else if (upperValue.includes('TAMAMLAND') || upperValue.includes('Bƒ∞TTƒ∞')) {
                            value = `<span class="status-normal">${value}</span>`;
                        } else if (upperValue.includes('BEKL') || upperValue.includes('DEVAM')) {
                            value = `<span class="status-pending">${value}</span>`;
                        } else {
                            value = `<span class="status-pending">${value}</span>`;
                        }
                    }
                    
                    return `<td class="${cellClass}" title="${String(row[col] || '')}">${value}</td>`;
                }).join('') + '</tr>'
            ).join('');
        }
        
        function filterByColumn(column, value) {
            if (value.trim() === '') {
                delete columnFilters[column];
            } else {
                columnFilters[column] = value.toLowerCase();
            }
            applyAllFilters();
        }
        
        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = allData.filter(row => {
                // Genel arama
                const matchesSearch = search === '' || Object.values(row).some(val => 
                    String(val).toLowerCase().includes(search)
                );
                
                // Kolon filtreleri
                const matchesColumnFilters = Object.keys(columnFilters).every(col => {
                    const filterValue = columnFilters[col];
                    const cellValue = String(row[col] || '').toLowerCase();
                    return cellValue.includes(filterValue);
                });
                
                return matchesSearch && matchesColumnFilters;
            });
            
            const columns = Object.keys(allData[0] || {});
            renderTableBody(columns);
            updateStats();
        }
        
        function applyAllFilters() {
            filterData();
        }
        
        function sortTable(column) {
            filteredData.sort((a, b) => {
                let aVal = String(a[column] || '');
                let bVal = String(b[column] || '');
                
                // Tarih kolonlarƒ± i√ßin √∂zel sƒ±ralama
                if (dateColumns.includes(column)) {
                    const aDate = parseDate(aVal);
                    const bDate = parseDate(bVal);
                    
                    if (aDate && bDate) {
                        return aDate - bDate;
                    } else if (aDate) {
                        return -1;
                    } else if (bDate) {
                        return 1;
                    }
                }
                
                // Sayƒ± kontrol√º
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                }
                
                return aVal.toLowerCase().localeCompare(bVal.toLowerCase(), 'tr');
            });
            
            const columns = Object.keys(allData[0] || {});
            renderTableBody(columns);
        }
        
        function parseDate(dateStr) {
            if (!dateStr || dateStr === '' || dateStr === 'NaT' || dateStr === 'nan') return null;
            
            const parts = dateStr.split('.');
            if (parts.length === 3) {
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }
            
            return null;
        }
        
        function updateStats() {
            document.getElementById('totalRows').textContent = allData.length;
            document.getElementById('filteredRows').textContent = filteredData.length;
            document.getElementById('hiddenRows').textContent = hiddenRowsCount;
            document.getElementById('columnCount').textContent = Object.keys(allData[0] || {}).length;
        }
        
        // Excel Export Fonksiyonu
        function exportToExcel() {
            try {
                if (filteredData.length === 0) {
                    showExportMessage('‚ùå Export edilecek veri bulunamadƒ±!', false);
                    return;
                }

                // Mevcut filtrelenmi≈ü verileri al
                const dataToExport = filteredData.map(row => {
                    const cleanRow = {};
                    Object.keys(row).forEach(key => {
                        // HTML etiketlerini temizle
                        let value = row[key];
                        if (typeof value === 'string') {
                            value = value.replace(/<[^>]*>/g, '');
                        }
                        cleanRow[key] = value || '';
                    });
                    return cleanRow;
                });

                // Excel workbook olu≈ütur
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(dataToExport);

                // Kolon geni≈üliklerini ayarla
                const colWidths = [];
                Object.keys(dataToExport[0] || {}).forEach(key => {
                    const maxLength = Math.max(
                        key.length,
                        ...dataToExport.slice(0, 100).map(row => String(row[key] || '').length)
                    );
                    colWidths.push({ width: Math.min(Math.max(maxLength + 2, 10), 50) });
                });
                ws['!cols'] = colWidths;

                // Worksheet'i workbook'a ekle
                XLSX.utils.book_append_sheet(wb, ws, 'Pipeline Data');

                // Dosya adƒ±nƒ± olu≈ütur
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const filename = `Pipeline_Deneme_${dateStr}_${filteredData.length}_kayit.xlsx`;

                // Excel dosyasƒ±nƒ± indir
                XLSX.writeFile(wb, filename);

                showExportMessage(`‚úÖ Excel dosyasƒ± indirildi: ${filename} (${filteredData.length} kayƒ±t)`, true);

            } catch (error) {
                console.error('Excel export hatasƒ±:', error);
                showExportMessage('‚ùå Excel export sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, false);
            }
        }

        // CSV Export Fonksiyonu  
        function exportToCSV() {
            try {
                if (filteredData.length === 0) {
                    showExportMessage('‚ùå Export edilecek veri bulunamadƒ±!', false);
                    return;
                }

                // CSV i√ßeriƒüi olu≈ütur
                const headers = Object.keys(filteredData[0]);
                const csvContent = [
                    headers.join(','),
                    ...filteredData.map(row => 
                        headers.map(header => {
                            let value = row[header] || '';
                            // HTML etiketlerini temizle
                            if (typeof value === 'string') {
                                value = value.replace(/<[^>]*>/g, '');
                            }
                            // Virg√ºl i√ßeren deƒüerleri tƒ±rnak i√ßine al
                            if (String(value).includes(',')) {
                                return `"${String(value).replace(/"/g, '""')}"`;
                            }
                            return String(value);
                        }).join(',')
                    )
                ].join('\n');

                // CSV dosyasƒ±nƒ± indir
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                const filename = `Pipeline_Deneme_${dateStr}_${filteredData.length}_kayit.csv`;

                link.setAttribute('href', URL.createObjectURL(blob));
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showExportMessage(`‚úÖ CSV dosyasƒ± indirildi: ${filename} (${filteredData.length} kayƒ±t)`, true);

            } catch (error) {
                console.error('CSV export hatasƒ±:', error);
                showExportMessage('‚ùå CSV export sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, false);
            }
        }

        // Export mesajƒ± g√∂ster
        function showExportMessage(message, isSuccess) {
            const exportInfo = document.getElementById('exportInfo');
            exportInfo.style.display = 'block';
            exportInfo.textContent = message;
            
            if (isSuccess) {
                exportInfo.style.background = '#e8f5e8';
                exportInfo.style.color = '#2e7d32';
            } else {
                exportInfo.style.background = '#ffebee';
                exportInfo.style.color = '#c62828';
            }

            // 5 saniye sonra mesajƒ± gizle
            setTimeout(() => {
                exportInfo.style.display = 'none';
            }, 5000);
        }
        document.addEventListener('DOMContentLoaded', loadData);
        setInterval(loadData, 900000); // 15 dakika = 900000 ms
    </script>
</body>
</html>